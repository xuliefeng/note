# 磁盘存储

kafka 使用硬盘来存储和缓存消息。对于消息的写入采用了文件追加的方式，只能在文件的尾部追加新的消息，并且对于已经写入的消息不允许修改。这种方式属于典型的顺序写盘操作。

## 页缓存

页缓存是操作系统实现的一种主要的磁盘缓存，用此来减少对磁盘 i/o 的操作。具体来说，就是把磁盘中的数据缓存到内存总，把对磁盘的访问变成对内存的访问。

读取流程：process <- page (pagecache) <- disk  
写入流程：process -> page (pagecache) -> disk

Linux 中 vm.dirty_background_ratio 参数可以控制当内存中的脏页数量达到系统内存的百分之多少之后就会触发后台回写进程来进行脏页数据的处理，一般设置小于 10 的值。vm.dirty_ratio 参数可以控制当内存中的脏页数量达到内存的百分之多少之后就不得不开始对脏页进行处理，在次过程中，新的 I/O 请求会被阻挡直到所有脏页都被冲刷到磁盘中。

通常来说一个进程会在内部缓存处理所需的数据，然而这些数据有可能还在缓存在操作系统的页缓存中，因此同一份数据有可能被缓存来两次。并且除非使用Direct I/O的方式，否则页缓存很难被禁止。此外java的中的对象内存开销非常大，一个对象占用的内存通常会是真实数据大小的几倍甚至更多，空间使用率低下；而且Java的垃圾回收会随着堆内数据的增多而变得越来越慢。   
基于这些原因使用文件系统并且依赖于页缓存的做法明显要优于维护一个进程内缓存或其他结构，至少可以省去一份内存进程内部的缓存消耗，同时还可以通过结构紧凑的字节码来代替使用对象方式以节省更多的内存。并且在一个大内存的机器上也不用当心因为GC而带来的性能问题，其外由于使用了页缓存模式即使kafka重启数据还是存在并且有效的。   

kafka中大量使用来页缓存，并且同时提供来同步刷盘以及间接性强制刷屏的功能（log.flush.interval.message,log.flush.interval.ms）。同步刷盘可以提高消息的可靠性，防止由于机器掉电等异常造成处于页缓存而没有及时写入磁盘的消息丢失。不过该行为不提倡，消息的可靠性应该由多副本机制来保障，而不是由同步刷盘这种严重影响性能的行为来保障。   

Linux中存在使用磁盘来作为swap分区的功能，对于非活跃的进程数据会写入该分区。这种模式对于大量使用页缓存的kafka是一个很大的负面影响需要特别关注。
